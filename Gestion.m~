function [Tab1 Tab2] = Gestion(FMethRefIN, FEauRefIN, TRefOUT, TWGS )
%UNTITLED Summary of this function goes here
%   Detailed explanation goes here


%F = flux
%Q = chaleur
%ref = reformateur
%WGS = watergazshift
%Meth = methane
%Eau = eau
%H2 = H2
%C0 = CO
%CO2 = CO2

%% On met des parametre par default si besoin
if(~isnumeric(FMethRefIN))
    FMethRefIN = 400;
end
if(~isnumeric(FEauRefIN))
    FEauRefIN = 1500;
end
if(~isnumeric(TRefOUT))
    TRefOUT = 1108;
end
if(~isnumeric(TWGS))
    TWGS = 650;
end

format long
%% Declaration et changement d'unite

cpFour = 1200;%[J/kgK]
cpProc = 2900 ;%[J/kgK]
TFourIN = 300; %[K]
TFourOUT = 1300; %[K]
TRefIN = 300; %[K]

MMeth = 0.016;
MEau = 0.018;
MH2 = 0.002;
MCo = 0.028;
MCo2 = 0.044;
MAir = 0.0296;
MO2 = 0.032;
MN2 = 0.028;

FMethRefIN = FMethRefIN * 10^3 /86400 / MMeth; % Conversion T/j en mol/s
FEauRefIN = FEauRefIN * 10^3 /86400 / MEau; % Conversion T/j en mol/s

%% Double equilibre
[XSI1, XSI2] = Double_eq(FMethRefIN,FEauRefIN,TRefOUT);

FMethRefOUT = FMethRefIN - XSI1;
FEauRefOUT = FEauRefIN - XSI1 - XSI2;
FH2RefOUT = 3 * XSI1 + XSI2;
FCoRefOUT = XSI1 - XSI2;
FCo2RefOUT = XSI2;

%% PREMIER REACTEUR WGS
[XSI3] = WGS(FCoRefOUT,FEauRefOUT,FH2RefOUT,FCo2RefOUT,TWGS);

%Si complete alors
%{
    XSI3 = min (FMethRefOUT, FEauRefOUT);
%}

FMethWGS1OUT = FMethRefOUT;
FEauWGS1OUT = FEauRefOUT- XSI3;
FH2WGS1OUT = FH2RefOUT + XSI3;
FCoWGS1OUT = FCoRefOUT  - XSI3;
FCo2WGS1OUT = FCo2RefOUT + XSI3;


%% SECOND REACTEUR WGS

[XSI4] = WGS(FCoWGS1OUT,FEauWGS1OUT,FH2WGS1OUT,FCo2WGS1OUT,470);

%Si complete alors
%{
    XSI4 = min (FMethRefOUT, FEauRefOUT);
%}

FMethWGS2OUT = FMethWGS1OUT;
FEauWGS2OUT = FEauWGS1OUT- XSI4;
FH2WGS2OUT = FH2WGS1OUT + XSI4;
FCoWGS2OUT = FCoWGS1OUT  - XSI4;
FCo2WGS2OUT = FCo2WGS1OUT + XSI4;


%% ENERGIE
%chauffer gaz reformeur
FQRefChauffe = cpProc * (TRefOUT - 800) * (FMethRefIN * MMeth + FEauRefIN * MEau ) ;

%Energie reformeur
FQRefOUT = XSI1 * 224000 + XSI2 * -34000;

%refroidir gaz refromeur - WGS1
FQRefWGSFroid = cpProc * (TRefOUT-TWGS) * (FMethRefOUT * MMeth + FEauRefOUT * MEau ...
    + FH2RefOUT * MH2 + FCoRefOUT * MCo + FCo2RefOUT * MCo2);

%Energie WGS1
FQWGS1OUT = XSI3 * -34000;

%refroidir gaz WGS1 - WGS2
FQWGS1WGS2Froid = cpProc * (TWGS-470) * (FMethWGS1OUT * MMeth + FEauWGS1OUT * MEau ...
    + FH2WGS1OUT * MH2 + FCoWGS1OUT * MCo + FCo2WGS1OUT * MCo2);

%Energie WGS2
FQWGS2OUT = XSI4* -34000;

%EST CE QUE C'EST TOUJOURS TREFIN = 800 ????

%TRefIN
%TRefIN = TRefIN + (FQRefWGSFroid + FQWGS1WGS2Froid) / (cpProc* (FMethRefIN * MMeth + FEauRefIN * MEau ));

%Calcul de l'enerige necessaire
FmolFourIN = ChaleurFour((FQRefChauffe + FQRefOUT),TFourIN, TFourOUT);

%chauffer gaz four
FQFourChauffe = cpFour * (TFourOUT - TFourIN) *  FmolFourIN * (MMeth + MAir*20/19);

%Energie combustion
FQFour = FmolFourIN *-803000;

FMethFourIN = FmolFourIN;
FO2FourIN = FmolFourIN * 2 * 20/19;
FN2FourIN = FO2FourIN *79/21;
FAirFourIN = FO2FourIN *100/21;

FO2FourOUT = FmolFourIN * 2 * 1/19;
FEauFourOUT = 2 * FmolFourIN;
FCo2FourOUT = FmolFourIN;

%% Metanation
%CHANGER PAR LE MIN FAIS PAS LE CON PHILIPPE

FMethMethOUT = FMethWGS2OUT + FCoWGS2OUT;
FH2MethOUT = FH2WGS2OUT - 3*FCoWGS2OUT;
FEauMethOUT = FCoWGS2OUT;

%% Resultat

%Meth Eau Co Co2 H2
Tab1 = [FMethRefIN FEauRefIN 0 0 0;...
    FMethRefOUT FEauRefOUT FCoRefOUT FCo2RefOUT FH2RefOUT;...
    FMethWGS1OUT FEauWGS1OUT FCoWGS1OUT FCo2WGS1OUT FH2WGS1OUT;...
    FMethWGS2OUT FEauWGS2OUT FCoWGS2OUT FCo2WGS2OUT FH2WGS2OUT;...
    FMethWGS2OUT 0 FCoWGS2OUT 0 FH2WGS2OUT;...
    FMethMethOUT FEauMethOUT 0 0 FH2MethOUT;...
    FMethMethOUT FEauMethOUT 0 0 FH2MethOUT];
Tab1(end,:) = Tab1(end,:) * 86400  .*[MMeth, MEau, MCo, MCo2, MH2] / 10^3;

%Meth Eau Air
format bank
Tab2 = [FMethFourIN 0 FO2FourIN FN2FourIN FAirFourIN; FMethFourIN 0 FAirFourIN; FMethFourIN+FMethRefIN FEauRefIN FAirFourIN; FMethFourIN+FMethRefIN FEauRefIN FAirFourIN];
Tab2(2,:) = Tab2(2,:) * 86400  .*[MMeth MEau MAir] / 10^3;
Tab2(4,:) = Tab2(4,:)* 86400  .*[MMeth MEau MAir] / 10^3;
end

